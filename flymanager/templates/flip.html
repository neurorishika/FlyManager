{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center">FlyFlipper</h2>
    <div id="port-selection" class="mb-3">
        <label for="serialPort" class="form-label">Select Serial Port:</label>
        <select class="form-select" id="serialPort">
            {% for port in ports %}
                <option value="{{ loop.index0 }}">{{ port.device }} - {{ port.description }}</option>
            {% endfor %}
        </select>
        <button id="startScanBtn" class="btn btn-primary mt-3" style="display: block;">Start Scan</button>
    </div>


    <div id="stock-details" style="display: none;">
        <h2>Stock Details</h2>
        <p><strong>Unique ID:</strong> <span id="uniqueID"></span></p>
        <p><strong>Series ID:</strong> <span id="seriesID"></span></p>
        <p><strong>Replicate ID:</strong> <span id="replicateID"></span></p>
        <p><strong>Name:</strong> <span id="name"></span></p>
        <p><strong>Genotype:</strong> <span id="genotype"></span></p>


        <h3>Status</h3>
        <div id="status-options">
            <label>
                <input type="radio" name="status" value="Healthy"> Healthy
            </label>
            <label>
                <input type="radio" name="status" value="Showing Issues"> Showing Issues
            </label>
            <label>
                <input type="radio" name="status" value="Needs refresh"> Needs refresh
            </label>
            <label>
                <input type="radio" name="status" value="Ordered"> Ordered
            </label>
            <label>
                <input type="radio" name="status" value="No longer maintained"> No longer maintained
            </label>
        </div>

        <h3>Flip Time</h3>
        <input type="datetime-local" id="flipTime" class="form-control" value="{{ now }}">

        <h3>Add Comment</h3>
        <textarea id="comment" class="form-control" rows="3"></textarea>

        <button id="flipBtn" class="btn btn-success mt-3">Flip Stock</button>
    </div>
    <br>
    <br>
    <div id="scan-waiting" class="text-center" style="display: none;">
        <h3>Waiting for QR code to be scanned...</h3>
        <div class="spinner-border" role="status">
            <span class="visually-hidden"></span>
        </div>
        <br>
        <button id="stopScanBtn" class="btn btn-danger mt-3">Stop</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/fly_flipper.js') }}"></script>
    <!-- <script>
    document.addEventListener("DOMContentLoaded", function() {
        const socket = io.connect('http://127.0.0.1:5000');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const portSelection = document.getElementById('serialPort');
        const scanWaiting = document.getElementById('scan-waiting');
        const stockDetails = document.getElementById('stock-details');
        let currentThreadId = null;

        // Function to get the current datetime in the local time zone
        function getLocalDateTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000; // getTimezoneOffset returns minutes, so convert to milliseconds
            const localTime = new Date(now - offset);
            return localTime.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
        }

        // Function to flip the stock
        function flipFliesFromView() {
            if (stockDetails.style.display === 'block') {
                const status = document.querySelector('input[name="status"]:checked').value;
                const flipTime = document.getElementById('flipTime').value;
                const comment = document.getElementById('comment').value;
                const uniqueID = document.getElementById('uniqueID').textContent;

                return fetch('/flip_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: status, flipTime: flipTime, comment: comment, uniqueID: uniqueID })
                })
                .then(response => response.json())
                .then(info => {
                    document.getElementById('uniqueID').textContent = '';
                    document.getElementById('seriesID').textContent = '';
                    document.getElementById('replicateID').textContent = '';
                    document.getElementById('name').textContent = '';
                    document.getElementById('genotype').textContent = '';
                    document.querySelector(`input[name="status"][value="Healthy"]`).checked = true;
                    document.getElementById('flipTime').value = getLocalDateTime();
                    document.getElementById('comment').value = '';
                    stockDetails.style.display = 'none';
                    alert('Stock flipped successfully!');
                })
            }
            else {
                return Promise.resolve()
            }
        }

        startScanBtn.addEventListener('click', function() {
            const selectedPort = portSelection.value;
            scanWaiting.style.display = 'block';
            startScanBtn.style.display = 'none';

            fetch('/start_scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ port_index: selectedPort })
            })
            .then(response => response.json())
            .then(data => {
                currentThreadId = data.thread_id;
            });
        });

        stopScanBtn.addEventListener('click', function() {
            if (currentThreadId) {
                // flip the stock
                flipFliesFromView().then(() => {
                    scanWaiting.style.display = 'none';
                    startScanBtn.style.display = 'block';
                    fetch('/stop_scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ thread_id: currentThreadId })
                    });
                });
            }
        });

        window.addEventListener('beforeunload', function() {
            if (currentThreadId) {
                flipFliesFromView().then(() => {
                    scanWaiting.style.display = 'none';
                    startScanBtn.style.display = 'block';
                    fetch('/stop_scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ thread_id: currentThreadId })
                    });
                });
            }
        });

        socket.on('qr_scanned', function(data) {
            // check if there is a fly being viewed
            if (stockDetails.style.display === 'block') {
                // flip the stock
                const status = document.querySelector('input[name="status"]:checked').value;
                const flipTime = document.getElementById('flipTime').value;
                const comment = document.getElementById('comment').value;
                const uniqueID = document.getElementById('uniqueID').textContent;

                // send the flip request and wait for the response, then display the stock details
                fetch('/flip_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: status, flipTime: flipTime, comment: comment, uniqueID: uniqueID })
                })
                .then(response => response.json())
                .then(info => {
                    document.getElementById('uniqueID').textContent = data.uniqueID;
                    document.getElementById('seriesID').textContent = data.seriesID;
                    document.getElementById('replicateID').textContent = data.replicateID;
                    document.getElementById('name').textContent = data.name;
                    document.getElementById('genotype').textContent = data.genotype;
                    document.querySelector(`input[name="status"][value="${data.status}"]`).checked = true;
                    document.getElementById('flipTime').value = getLocalDateTime();
                });
            }
            else {
                // display the stock details
                document.getElementById('uniqueID').textContent = data.uniqueID;
                document.getElementById('seriesID').textContent = data.seriesID;
                document.getElementById('replicateID').textContent = data.replicateID;
                document.getElementById('name').textContent = data.name;
                document.getElementById('genotype').textContent = data.genotype;
                document.querySelector(`input[name="status"][value="${data.status}"]`).checked = true;
                document.getElementById('flipTime').value = getLocalDateTime();

                stockDetails.style.display = 'block';
            }
        });

        socket.on('qr_not_recognized', function() {
            alert('QR code not recognized. Please try again.');
        });

        // Flip the stock when the flip button is clicked
        const flipBtn = document.getElementById('flipBtn');
        flipBtn.addEventListener('click', function() {
            const status = document.querySelector('input[name="status"]:checked').value;
            const flipTime = document.getElementById('flipTime').value;
            const comment = document.getElementById('comment').value;
            const uniqueID = document.getElementById('uniqueID').textContent;
            
            fetch('/flip_stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: status, flipTime: flipTime, comment: comment, uniqueID: uniqueID })
            })
            .then(response => response.json())
            .then(data => {
                stockDetails.style.display = 'none';
                alert('Stock flipped successfully!');
            });
        });

    });
    </script> -->
{% endblock %}
