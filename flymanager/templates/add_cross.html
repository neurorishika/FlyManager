{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Add New Cross</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <!-- Port Selection for Scanning -->
    <div id="port-selection" class="row mb-3 align-items-center justify-content-center">
        <div class="col-auto">
            <select class="form-select" id="serialPort">
                {% for port in ports %}
                    <option value="{{ loop.index0 }}">{{ port.device }} - {{ port.description }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <form method="POST" action="/add_cross">
        <!-- Row 1: Male Unique ID and Genotype -->
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="maleUniqueID">Male Unique ID:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="maleUniqueID" name="maleUniqueID">
                    <button id="scanMaleUIDBtn" class="btn btn-secondary" type="button">Scan UID</button>
                </div>
                
            </div>
            <div class="form-group col-md-9">
                <label for="maleGenotype">Male Genotype:</label>
                <input type="text" id="maleGenotype" name="maleGenotype" class="form-control tag-input">
                <div id="maleUIDOptions" class="mt-2"></div> <!-- Placeholder for UID buttons -->
            </div>
        </div>

        <!-- Row 2: Female Unique ID and Genotype -->
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="femaleUniqueID">Female Unique ID:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="femaleUniqueID" name="femaleUniqueID">
                    <button id="scanFemaleUIDBtn" class="btn btn-secondary" type="button">Scan UID</button>
                </div>
                
            </div>
            <div class="form-group col-md-9">
                <label for="femaleGenotype">Female Genotype:</label>
                <input type="text" id="femaleGenotype" name="femaleGenotype" class="form-control tag-input">
                <div id="femaleUIDOptions" class="mt-2"></div> <!-- Placeholder for UID buttons -->
            </div>
        </div>

        <!-- Row 3: Tray ID, Tray Position, and Status -->
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="trayID">Tray ID:</label>
                <input type="text" class="form-control" id="trayID" name="trayID">
            </div>
            <div class="form-group col-md-4">
                <label for="trayPosition">Tray Position:</label>
                <input type="text" class="form-control" id="trayPosition" name="trayPosition">
            </div>
            <div class="form-group col-md-4">
                <label for="status">Status:</label>
                <select class="form-control" id="status" name="status">
                    <option value="Healthy" data-color="green">Healthy</option>
                    <option value="Showing Issues" data-color="brown">Showing Issues</option>
                    <option value="Needs refresh" data-color="red">Needs refresh</option>
                    <option value="Ordered" data-color="blue">Ordered</option>
                    <option value="No longer maintained" data-color="pink">No longer maintained</option>
                </select>
            </div>
        </div>

        <!-- Row 4: Food Type and Cross Name -->
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="foodType">Food Type:</label>
                <input type="text" id="foodType" name="foodType" class="form-control tag-input" value="Molasses">
            </div>
            <div class="form-group col-md-6">
                <label for="name">Cross Name:</label>
                <input type="text" class="form-control" id="name" name="name">
            </div>
        </div>

        <!-- Row 5: Vial Lifetime, Flip Frequency and Developmental Time -->
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="vialLifetime">Vial Lifetime (days):</label>
                <input type="number" class="form-control" id="vialLifetime" name="vialLifetime" value="14">
            </div>
            <div class="form-group col-md-4">
                <label for="flipFrequency">Flip Frequency (days):</label>
                <input type="number" class="form-control" id="flipFrequency" name="flipFrequency" value="7">
            </div>
            <div class="form-group col-md-4">
                <label for="developmentalTime">Mating->Virgin Adult (days):</label>
                <input type="number" class="form-control" id="developmentalTime" name="developmentalTime" value="7">
            </div>
        </div>

        <!-- Row 6: Comments -->
        <div class="form-group">
            <label for="comments">Comments:</label>
            <textarea class="form-control" id="comments" name="comments" rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-success btn-block">Add Cross</button>
    </form>
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>

    const crossData = {{ cross_data | tojson }};

    document.addEventListener("DOMContentLoaded", function() {
        const socket = io.connect('http://127.0.0.1:5000');
        let currentThreadId = null;

        // Function to start scanning
        function startScanning(gender) {
            const selectedPort = document.getElementById('serialPort').value;

            fetch('/start_scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ port_index: selectedPort })
            })
            .then(response => response.json())
            .then(data => {
                currentThreadId = data.thread_id;
                if (gender === 'male') {
                    document.getElementById('scanMaleUIDBtn').textContent = "Stop Scan";
                } else {
                    document.getElementById('scanFemaleUIDBtn').textContent = "Stop Scan";
                }
            });
        }

        // Function to stop scanning
        function stopScanning(gender) {
            fetch('/stop_scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ thread_id: currentThreadId })
            })
            .then(() => {
                currentThreadId = null;
                if (gender === 'male') {
                    document.getElementById('scanMaleUIDBtn').textContent = "Scan UID";
                } else {
                    document.getElementById('scanFemaleUIDBtn').textContent = "Scan UID";
                }
            });
        }

        // Handle scan button for Male UID
        document.getElementById('scanMaleUIDBtn').addEventListener('click', function() {
            if (currentThreadId) {
                stopScanning('male');
            } else {
                startScanning('male');
            }
        });

        // Handle scan button for Female UID
        document.getElementById('scanFemaleUIDBtn').addEventListener('click', function() {
            if (currentThreadId) {
                stopScanning('female');
            } else {
                startScanning('female');
            }
        });

        socket.on('stock_scanned', function(data) {
            if (currentThreadId) {
                if (document.getElementById('scanMaleUIDBtn').textContent === "Stop Scan") {
                    document.getElementById('maleUniqueID').value = data.uniqueID;
                    // Trigger the input event to fetch the genotype
                    document.getElementById('maleUniqueID').dispatchEvent(new Event('input'));
                    stopScanning('male');
                } else if (document.getElementById('scanFemaleUIDBtn').textContent === "Stop Scan") {
                    document.getElementById('femaleUniqueID').value = data.uniqueID;
                    // Trigger the input event to fetch the genotype
                    document.getElementById('femaleUniqueID').dispatchEvent(new Event('input'));
                    stopScanning('female');
                }
            }
        });

        socket.on('qr_not_recognized', function() {
            alert('QR code not recognized. Please try again.');
        });

        // Initialize Tagify for Male and Female Genotypes
        let tagifyMaleGenotype = new Tagify(document.querySelector('#maleGenotype'), {
            whitelist: {{ genotypes | tojson }},
            maxTags: 1,
            enforceWhitelist: true,
            dropdown: {
                enabled: 1
            },
            delimiters: null
        });

        let tagifyFemaleGenotype = new Tagify(document.querySelector('#femaleGenotype'), {
            whitelist: {{ genotypes | tojson }},
            maxTags: 1,
            enforceWhitelist: true,
            dropdown: {
                enabled: 1
            },
            delimiters: null
        });

        // Fetch UIDs when Male Genotype is selected
        tagifyMaleGenotype.on('add', function(e) {
            const selectedGenotype = e.detail.data.value;
            if (selectedGenotype) {
                fetch(`/get_uids/${encodeURIComponent(encodeURIComponent(selectedGenotype))}`)
                    .then(response => response.json())
                    .then(data => {
                        const maleUIDOptions = document.getElementById('maleUIDOptions');
                        maleUIDOptions.innerHTML = '';
                        data.uids.forEach(uid => {
                            let button = document.createElement('button');
                            button.className = 'btn btn-outline-primary btn-sm m-1 m-uid-button';
                            button.textContent = uid;
                            button.type = 'button';
                            button.style.display = 'inline-block';
                            button.onclick = function() {
                                document.getElementById('maleUniqueID').value = uid;
                                document.querySelectorAll('.m-uid-button').forEach(button => {
                                    button.style.display = 'none';
                                });
                            };
                            maleUIDOptions.appendChild(button);
                        });
                    });
            }
        });

        // Fetch UIDs when Female Genotype is selected
        tagifyFemaleGenotype.on('add', function(e) {
            const selectedGenotype = e.detail.data.value;
            if (selectedGenotype) {
                fetch(`/get_uids/${encodeURIComponent(encodeURIComponent(selectedGenotype))}`)
                    .then(response => response.json())
                    .then(data => {
                        const femaleUIDOptions = document.getElementById('femaleUIDOptions');
                        femaleUIDOptions.innerHTML = '';
                        data.uids.forEach(uid => {
                            let button = document.createElement('button');
                            button.className = 'btn btn-outline-primary btn-sm m-1 f-uid-button';
                            button.textContent = uid;
                            button.type = 'button';
                            button.style.display = 'inline-block';
                            button.onclick = function() {
                                document.getElementById('femaleUniqueID').value = uid;
                                document.querySelectorAll('.f-uid-button').forEach(button => {
                                    button.style.display = 'none';
                                });
                            };
                            femaleUIDOptions.appendChild(button);
                        });
                    });
            }
        });

        // Fetch genotype when Male Unique ID is entered or scanned
        document.getElementById('maleUniqueID').addEventListener('input', function() {
            const maleUID = this.value;
            if (maleUID) {
                fetch(`/get_genotype/${maleUID}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.genotype) {
                            // Remove any existing tags
                            tagifyMaleGenotype.removeAllTags();
                            tagifyMaleGenotype.addTags([data.genotype]);
                        }
                    });
            }
        });

        document.getElementById('femaleUniqueID').addEventListener('input', function() {
            const femaleUID = this.value;
            if (femaleUID) {
                fetch(`/get_genotype/${femaleUID}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.genotype) {
                            // Remove any existing tags
                            tagifyFemaleGenotype.removeAllTags();
                            tagifyFemaleGenotype.addTags([data.genotype]);
                        }
                    });
            }
        });

        let tagifyFoodType = new Tagify(document.querySelector('#foodType'), {
            whitelist: {{ food_types | tojson }},
            maxTags: 1,
        });

        // Populate form fields if cross data is provided
        // check if crossData is not empty
        if (Object.keys(crossData).length > 0) {
            document.getElementById('maleUniqueID').value = crossData.maleUniqueID;
            document.getElementById('femaleUniqueID').value = crossData.femaleUniqueID;
            document.getElementById('vialLifetime').value = crossData.vialLifetime;
            document.getElementById('flipFrequency').value = crossData.flipFrequency;
            document.getElementById('developmentalTime').value = crossData.developmentalTime;
            
            // Remove any existing tags
            tagifyMaleGenotype.removeAllTags();
            tagifyMaleGenotype.addTags([crossData.maleGenotype]);
            tagifyFemaleGenotype.removeAllTags();
            tagifyFemaleGenotype.addTags([crossData.femaleGenotype]);

            // set the status dropdown
            const statusDropdown = document.getElementById('status');
            for (let i = 0; i < statusDropdown.options.length; i++) {
                if (statusDropdown.options[i].value === crossData.status) {
                    statusDropdown.selectedIndex = i;
                    break;
                }
            }

            // Remove any existing tags on food type
            tagifyFoodType.removeAllTags();
            tagifyFoodType.addTags([crossData.foodType]);

            document.getElementById('name').value = crossData.name;
            document.getElementById('comments').value = crossData.comments;
        }
    });
</script>
{% endblock %}
